<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard</title>

<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI',sans-serif}
body{background:linear-gradient(135deg,#0b1d61,#08123a);color:#fff;min-height:100vh}
header{display:flex;justify-content:space-between;align-items:center;padding:12px 25px;background:#0a184f;position:sticky;top:0;z-index:100}
.logo{width:50px;height:50px;border-radius:50%;border:2px solid #00aaff}
.user-profile{width:48px;height:48px;border-radius:50%;display:flex;align-items:center;justify-content:center;border:2px solid #00aaff;background:#1a2b8f;font-size:22px;color:#fff;text-decoration:none}
.user-info{max-width:820px;margin:30px auto;background:#101e5a;padding:25px;border-radius:18px;box-shadow:0 20px 40px rgba(0,0,0,.4)}
.user-info h2{text-align:center;color:#00aaff;margin-bottom:20px}
.info-grid{display:grid;grid-template-columns:1fr 1fr;gap:15px}
.info-box{background:#1a2b8f;padding:15px;border-radius:12px}
.info-box span{font-size:13px;opacity:.8}
.info-box strong{display:block;font-size:17px;margin-top:5px}
.highlight{background:linear-gradient(135deg,#00aaff,#0066ff)}
.progress-bar{width:100%;height:10px;background:rgba(255,255,255,.25);border-radius:8px;overflow:hidden;margin-top:6px}
.progress{height:10px;background:#00e0ff;width:0%;transition:width .8s}
.freeze{background:#ff4c4c;text-align:center;padding:14px;border-radius:12px;margin-top:20px;font-weight:bold}
.cards-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:20px;max-width:900px;margin:30px auto;padding:0 20px}
.card{background:linear-gradient(135deg,#1a2b8f,#243bba);padding:26px;border-radius:18px;text-align:center;text-decoration:none;color:#fff;font-weight:600;transition:.25s}
.card:hover{transform:translateY(-6px)}
.card.disabled{opacity:.4;pointer-events:none}
.spinner{border:4px solid rgba(255,255,255,.3);border-top:4px solid #fff;border-radius:50%;width:42px;height:42px;animation:spin 1s linear infinite;margin:120px auto}
@keyframes spin{to{transform:rotate(360deg)}}
</style>
</head>

<body>

<header>
  <img src="logo.png" class="logo">
  <a href="profile.html" class="user-profile">ğŸ‘¤</a>
</header>

<div id="loading"><div class="spinner"></div></div>

<div class="user-info" id="userInfo" style="display:none">
  <h2>User Overview</h2>

  <div class="info-grid">
    <div class="info-box"><span>Name</span><strong id="name">-</strong></div>
    <div class="info-box"><span>Email</span><strong id="email">-</strong></div>

    <div class="info-box highlight">
      <span>Total Engagement</span>
      <strong id="totalEngagement">0</strong>
    </div>

    <div class="info-box highlight">
      <span>Level</span>
      <strong id="userLevel">0</strong>
      <div class="progress-bar">
        <div class="progress" id="levelProgress"></div>
      </div>
    </div>

    <div class="info-box"><span>Blog Time</span><strong id="blogTime">0</strong></div>
    <div class="info-box"><span>Game Time</span><strong id="gameTime">0</strong></div>

    <div class="info-box" style="grid-column:span 2">
      <span>Joined</span>
      <strong id="joined">-</strong>
    </div>
  </div>

  <div id="freezeBox" class="freeze" style="display:none">
    âš  Account temporarily restricted
  </div>
</div>

<div class="cards-row" id="cardsRow" style="display:none">
  <a href="redeem.html" class="card">ğŸ Redeem</a>
  <a href="rewards.html" class="card">ğŸ† Rewards</a>
  <a href="games.html" class="card">ğŸ® Games</a>
  <a href="blog.html" class="card">ğŸ“– Blog</a>
  
 <a href="Terms.html" class="card">ğŸ—ºï¸Terms</a>
 
  <a href="policies.html" class="card">ğŸ«‚ Policies</a>
 
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js";
import { getFirestore, doc, getDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";

const app = initializeApp({
  apiKey: "AIzaSyBe3E2eSUaDH5rZHguezaHjbxKmRA5QVd4",
  authDomain: "rewards-b8f54.firebaseapp.com",
  projectId: "rewards-b8f54"
});

const auth = getAuth(app);
const db = getFirestore(app);

const loading = document.getElementById("loading");
const userInfo = document.getElementById("userInfo");
const cardsRow = document.getElementById("cardsRow");

const nameEl = document.getElementById("name");
const emailEl = document.getElementById("email");
const joinedEl = document.getElementById("joined");
const totalEngagementEl = document.getElementById("totalEngagement");
const blogTimeEl = document.getElementById("blogTime");
const gameTimeEl = document.getElementById("gameTime");
const userLevelEl = document.getElementById("userLevel");
const levelProgressEl = document.getElementById("levelProgress");
const freezeBox = document.getElementById("freezeBox");

const formatTime = s=>{
  const h=Math.floor(s/3600);
  const m=Math.floor((s%3600)/60);
  return `${h}h ${m}m`;
};

onAuthStateChanged(auth, async user=>{
  if(!user) return location.replace("index.html");

  const userSnap = await getDoc(doc(db,"users",user.uid));
  if(!userSnap.exists()) return location.replace("index.html");

  const d = userSnap.data();
  if(d.reviewStatus!=="approved") return location.replace("approve.html");

  loading.style.display="none";
  userInfo.style.display="block";
  cardsRow.style.display="grid";

  nameEl.textContent=d.name||"-";
  emailEl.textContent=d.email||"-";
  joinedEl.textContent=d.createdAt?.toDate().toLocaleString()||"-";

  const totalEng=d.totalEngagement||0;
  totalEngagementEl.textContent=totalEng;
  blogTimeEl.textContent=formatTime(d.blogSeconds||0);
  gameTimeEl.textContent=formatTime(d.gameSeconds||0);

  /* ğŸ”¥ LEVEL SYSTEM (FIREBASE CONTROLLED) */
  const levelsSnap = await getDocs(collection(db,"levels"));
  let levels = [];

  levelsSnap.forEach(doc=>{
    levels.push(doc.data());
  });

  levels.sort((a,b)=>a.level-b.level);

  let currentLevel = levels[0];
  let nextLevel = null;

  for(let i=0;i<levels.length;i++){
    if(totalEng >= levels[i].requiredEngagement){
      currentLevel = levels[i];
      nextLevel = levels[i+1] || null;
    }
  }

  userLevelEl.textContent = currentLevel.level;

  let progress = 100;
  if(nextLevel){
    const range = nextLevel.requiredEngagement - currentLevel.requiredEngagement;
    const done = totalEng - currentLevel.requiredEngagement;
    progress = Math.min((done / range) * 100, 100);
  }

  levelProgressEl.style.width = progress + "%";

  if(d.frozen){
    freezeBox.style.display="block";
    document.querySelectorAll(".card").forEach(c=>c.classList.add("disabled"));
  }
});
</script>

</body>
</html>