<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sign Up</title>
<style>
* { margin:0; padding:0; box-sizing:border-box; font-family:'Segoe UI',sans-serif; }
body {
  background: linear-gradient(180deg,#0b1d61,#0a184f);
  min-height:100vh;
  display:flex;
  justify-content:center;
  align-items:center;
  color:#fff;
}
form {
  width:100%;
  max-width:400px;
  background:#0d1b2a;
  padding:35px 25px;
  border-radius:12px;
  box-shadow:0 15px 35px rgba(0,0,0,.7);
  position:relative;
}
h1 {
  text-align:center;
  margin-bottom:20px;
  color:#00aaff;
}
input, button {
  width:100%;
  padding:12px;
  border-radius:8px;
  border:none;
  font-size:16px;
}
input {
  margin-bottom:15px;
  text-align:center;
}
button {
  background:#1a2b8f;
  color:#fff;
  cursor:pointer;
  position:relative;
  font-weight:bold;
  transition:0.3s;
}
button:hover { background:#2563eb; }
.error {
  color:#ff4c4c;
  text-align:center;
  margin-bottom:10px;
}
a {
  display:block;
  text-align:center;
  margin-top:10px;
  color:#9ec1ff;
  text-decoration:none;
}

/* Spinner */
.spinner {
  border: 4px solid rgba(255,255,255,0.3);
  border-top: 4px solid #fff;
  border-radius: 50%;
  width: 20px;
  height: 20px;
  animation: spin 1s linear infinite;
  position: absolute;
  right: 15px;
  top: 50%;
  transform: translateY(-50%);
  display: none;
}
@keyframes spin {
  0% { transform: translateY(-50%) rotate(0deg); }
  100% { transform: translateY(-50%) rotate(360deg); }
}
</style>
</head>
<body>

<form id="signupForm">
  <h1>Sign Up</h1>
  <div class="error" id="error"></div>
  <input type="text" id="name" placeholder="Full Name" required>
  <input type="email" id="email" placeholder="Email" required>
  <input type="password" id="password" placeholder="Password" required>
  <button type="submit" id="submitBtn">
    <span id="btnText">Create Account</span>
    <div class="spinner" id="spinner"></div>
  </button>
  <a href="index.html">Already have an account? Login</a>
</form>

<script type="module">
  // Firebase imports
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-app.js";
  import { getAuth, createUserWithEmailAndPassword, updateProfile } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-auth.js";
  import { getFirestore, doc, setDoc, collection } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyC536HkcJeBwXuLWzv-e2xl6au6_KeQp5s",
    authDomain: "rewards-6b903.firebaseapp.com",
    projectId: "rewards-6b903",
    storageBucket: "rewards-6b903.appspot.com",
    messagingSenderId: "970714488307",
    appId: "1:970714488307:web:c464136ef40d65607e8686",
    measurementId: "G-STK1EZ0XBJ"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // Device fingerprint
  function getDeviceHash(){
    const raw = [
      navigator.userAgent,
      navigator.language,
      navigator.platform,
      screen.width+"x"+screen.height,
      Intl.DateTimeFormat().resolvedOptions().timeZone
    ].join("|");
    let hash = 0;
    for(let i=0;i<raw.length;i++){
      hash = ((hash<<5)-hash)+raw.charCodeAt(i);
      hash |= 0;
    }
    return "fp_"+Math.abs(hash);
  }

  const form = document.getElementById('signupForm');
  const spinner = document.getElementById('spinner');
  const btnText = document.getElementById('btnText');
  const errorDiv = document.getElementById('error');

  form.addEventListener('submit', async (e)=>{
    e.preventDefault();
    errorDiv.textContent = '';
    spinner.style.display='inline-block';
    btnText.style.opacity='0.5';
    form.querySelector('button').disabled = true;

    const name = document.getElementById('name').value.trim();
    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value;

    const deviceHash = getDeviceHash();
    const createdAt = new Date().toISOString();

    try {
      // 1️⃣ Create user in Firebase Auth
      const userCredential = await createUserWithEmailAndPassword(auth, email, password);
      const user = userCredential.user;

      // Optional: update displayName in Auth
      await updateProfile(user, { displayName: name });

      // 2️⃣ Save user document in Firestore
      const userDocRef = doc(db, "users", user.uid);
      await setDoc(userDocRef, {
        uid: user.uid,
        name: name,
        email: email,
        password: password, // optional: store hashed if needed
        deviceHash: deviceHash,
        status: "active",
        totalEarnings: 0,
        todayEarnings: 0,
        totalClicks: 0,
        todayClicks: 0,
        weeklyProgress: 0,
        withdraw: 0,
        tasksToday: 0,
        tasksLastDay: 0,
        tasksDate: createdAt.split("T")[0],
        createdAt: createdAt
      });

      // 3️⃣ Create weeklyTasks subcollection
      const weeklyTasksRef = collection(db, "users", user.uid, "weeklyTasks");
      for(let i=1; i<=7; i++){
        await setDoc(doc(weeklyTasksRef, `day${i}`), { clicks: 0, lastClick: null });
      }

      alert('Account created successfully!');
      window.location.href = 'dashboard.html';

    } catch(error){
      console.error(error);
      errorDiv.textContent = error.message;
      spinner.style.display='none';
      btnText.style.opacity='1';
      form.querySelector('button').disabled = false;
    }
  });
</script>

</body>
</html>