<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sign Up</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI',sans-serif}
body{background:#0b1d61;min-height:100vh;display:flex;justify-content:center;align-items:center;color:#fff}
form{width:100%;max-width:400px;background:#0d1b2a;padding:35px 25px;border-radius:12px;box-shadow:0 15px 35px rgba(0,0,0,.7);position:relative}
h1{text-align:center;margin-bottom:20px;color:#00aaff}
input,button{width:100%;padding:12px;border-radius:8px;border:none;font-size:16px}
input{margin-bottom:15px;text-align:center}
button{background:#1a2b8f;color:#fff;cursor:pointer;position:relative}
button:hover{background:#2a3bb5}
.error{color:#ff4c4c;text-align:center;margin-bottom:10px}
a{display:block;text-align:center;margin-top:10px;color:#9ec1ff;text-decoration:none}
.spinner{border:4px solid rgba(255,255,255,0.3);border-top:4px solid #fff;border-radius:50%;width:18px;height:18px;animation:spin 1s linear infinite;position:absolute;right:15px;top:50%;transform:translateY(-50%);display:none}
@keyframes spin{0%{transform:translateY(-50%) rotate(0deg)}100%{transform:translateY(-50%) rotate(360deg)}}
</style>
</head>
<body>

<form id="signupForm">
  <h1>Sign Up</h1>
  <div class="error" id="error"></div>
  <input type="text" id="name" placeholder="Full Name" required>
  <input type="email" id="email" placeholder="Email" required>
  <input type="password" id="password" placeholder="Password" required>
  <button type="submit" id="submitBtn">
    <span id="btnText">Create Account</span>
    <div class="spinner" id="spinner"></div>
  </button>
  <a href="index.html">Already have an account? Login</a>
</form>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey:"AIzaSyC536HkcJeBwXuLWzv-e2xl6au6_KeQp5s",
  authDomain:"rewards-6b903.firebaseapp.com",
  projectId:"rewards-6b903",
  storageBucket:"rewards-6b903.appspot.com",
  messagingSenderId:"970714488307",
  appId:"1:970714488307:web:c464136ef40d65607e8686"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

const form=document.getElementById('signupForm');
const errorDiv=document.getElementById('error');
const spinner=document.getElementById('spinner');
const btnText=document.getElementById('btnText');

// Fingerprint hash
function getDeviceHash(){
  const raw=[navigator.userAgent,navigator.language,navigator.platform,screen.width+"x"+screen.height,Intl.DateTimeFormat().resolvedOptions().timeZone].join("|");
  let hash=0;for(let i=0;i<raw.length;i++){hash=((hash<<5)-hash)+raw.charCodeAt(i);hash|=0;}
  return "fp_"+Math.abs(hash);
}

form.addEventListener('submit',async e=>{
  e.preventDefault();
  errorDiv.textContent='';
  spinner.style.display='inline-block';
  btnText.style.opacity='0.5';
  form.querySelector('button').disabled=true;

  const name=document.getElementById('name').value.trim();
  const email=document.getElementById('email').value.trim();
  const password=document.getElementById('password').value;
  const deviceHash=getDeviceHash();

  try{
    // Check if device already used
    const snap=await db.collection("users").where("deviceHash","==",deviceHash).get();
    let status=snap.empty?"active":"flagged";

    // Create Firebase Auth user
    const cred=await auth.createUserWithEmailAndPassword(email,password);
    await cred.user.updateProfile({displayName:name});

    const today=new Date();
    const todayStr=today.toISOString().split('T')[0];

    // Store user doc
    await db.collection("users").doc(cred.user.uid).set({
      uid:cred.user.uid,
      name:name,
      email:email,
      deviceHash:deviceHash,
      status:status,
      totalEarnings:0,
      todayEarnings:0,
      withdraw:0,
      weeklyProgress:0,
      createdAt:firebase.firestore.FieldValue.serverTimestamp()
    });

    // Create weekly tasks subcollection
    const batch=db.batch();
    const tasksRef=db.collection("users").doc(cred.user.uid).collection("weeklyTasks");
    for(let i=1;i<=7;i++){
      batch.set(tasksRef.doc("day"+i),{clicks:0,lastClick:null});
    }
    await batch.commit();

    alert('Account created successfully!');
    window.location.href='dashboard.html';

  }catch(err){
    console.log(err.message); // backend log
  }finally{
    spinner.style.display='none';
    btnText.style.opacity='1';
    form.querySelector('button').disabled=false;
  }
});
</script>

</body>
</html>