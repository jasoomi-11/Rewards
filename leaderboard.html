<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Leaderboard</title>
<style>
* { margin:0; padding:0; box-sizing:border-box; font-family:'Segoe UI',sans-serif; }
body{background:linear-gradient(135deg,#0b1d61,#08123a);color:#fff;min-height:100vh;display:flex;flex-direction:column;}
header { display:flex; justify-content:space-between; align-items:center; padding:12px 25px; background:#0a184f; box-shadow:0 4px 12px rgba(0,0,0,0.4); position:sticky; top:0; z-index:100; }
.header-left .logo { width:50px;height:50px;border-radius:50%;object-fit:cover;border:2px solid #00aaff; }

#loading { position:fixed; top:0; left:0; width:100%; height:100%; display:flex; justify-content:center; align-items:center; background:#08123a; z-index:999; }
.spinner { border:5px solid rgba(255,255,255,0.3); border-top:5px solid #00aaff; border-radius:50%; width:50px; height:50px; animation:spin 1s linear infinite; }
@keyframes spin{0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}

.leaderboard-container { max-width:900px; margin:30px auto; padding:0 15px; display:flex; flex-direction:column; gap:20px; }
table { width:100%; border-collapse:collapse; background:linear-gradient(135deg,#1a2b8f,#243bba); border-radius:12px; overflow:hidden; box-shadow:0 15px 30px rgba(0,0,0,0.35);}
thead { background:#0a184f; }
thead th { text-align:left; padding:12px 15px; color:#00e0ff; font-size:16px; }
tbody tr { transition:.3s; cursor:pointer; }
tbody tr:hover { background:rgba(0,170,255,0.2); }
tbody td { padding:12px 15px; font-size:15px; }
tbody tr.current-user { background:#00aaff33; font-weight:bold; }
footer{ text-align:center; padding:15px 0; margin-top:auto; background:#0a184f; box-shadow:0 -4px 12px rgba(0,0,0,0.4); font-size:14px; color:#00e0ff; }
</style>
</head>
<body>

<header>
  <div class="header-left"><img src="logo.png" alt="Logo" class="logo"></div>
</header>

<div id="loading"><div class="spinner"></div></div>

<div class="leaderboard-container" id="leaderboardContainer" style="display:none;">
  <table>
    <thead>
      <tr>
        <th>Position</th>
        <th>Name</th>
        <th>Weekly Clicks</th>
      </tr>
    </thead>
    <tbody id="leaderboardBody">
      <!-- Dynamic rows -->
    </tbody>
  </table>
</div>

<footer>JEETO All rights reserved</footer>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js";
import { getFirestore, collection, query, orderBy, getDocs, doc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";

// Firebase config
const app = initializeApp({
  apiKey: "AIzaSyBe3E2eSUaDH5rZHguezaHjbxKmRA5QVd4",
  authDomain: "rewards-b8f54.firebaseapp.com",
  projectId: "rewards-b8f54",
  storageBucket: "rewards-b8f54.appspot.com",
  messagingSenderId: "588528777945",
  appId: "1:588528777945:web:6dc9600f1f230e3813dcc8"
});

const auth = getAuth(app);
const db = getFirestore(app);

const loading = document.getElementById("loading");
const container = document.getElementById("leaderboardContainer");
const tbody = document.getElementById("leaderboardBody");

onAuthStateChanged(auth, async user => {
  if(!user) return location.replace("index.html");

  const userUid = user.uid;

  // Fetch all users and order by weeklyClicks
  const usersRef = collection(db, "users");
  const q = query(usersRef);
  const snapshot = await getDocs(q);

  let users = [];
  snapshot.forEach(docSnap => {
    const data = docSnap.data();
    users.push({
      uid: docSnap.id,
      name: data.name || "Unknown",
      weeklyClicks: data.weeklyClicks || 0
    });
  });

  // Sort descending
  users.sort((a,b) => b.weeklyClicks - a.weeklyClicks);

  // Build table
  tbody.innerHTML = "";
  users.forEach((u,index)=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${index+1}</td><td>${u.name}</td><td>${u.weeklyClicks}</td>`;
    if(u.uid === userUid) tr.classList.add("current-user");
    tbody.appendChild(tr);
  });

  // Update each user's leaderboard field (history)
  const today = new Date().toISOString().split("T")[0]; // YYYY-MM-DD
  const userRef = doc(db,"users",userUid);
  const currentUser = users.find(u=>u.uid===userUid);
  if(currentUser){
    try {
      await updateDoc(userRef,{
        leaderboard: [{ date: today, position: users.findIndex(u=>u.uid===userUid)+1, clicks: currentUser.weeklyClicks }],
        lastUpdated: serverTimestamp()
      });
    } catch(e){
      console.log("Failed to update leaderboard:", e);
    }
  }

  loading.style.display = "none";
  container.style.display = "flex";
});
</script>
</body>
</html>