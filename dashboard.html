<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI',sans-serif;}
body{background:linear-gradient(135deg,#0b1d61,#08123a);color:#fff;min-height:100vh;}
header{display:flex;justify-content:space-between;align-items:center;padding:18px 25px;background:#0a184f;border-bottom:2px solid #00aaff;}
.logout-btn{background:#ff4c4c;border:none;padding:10px 18px;border-radius:8px;color:#fff;cursor:pointer;}
.user-info{max-width:720px;margin:30px auto;background:#101e5a;padding:25px;border-radius:18px;box-shadow:0 20px 40px rgba(0,0,0,.4);}
.user-info h2{text-align:center;color:#00aaff;margin-bottom:20px;}
.info-grid{display:grid;grid-template-columns:1fr 1fr;gap:15px;}
.info-box{background:#1a2b8f;padding:15px;border-radius:12px;}
.info-box span{font-size:13px;opacity:.8;}
.info-box strong{display:block;font-size:17px;margin-top:5px;}
.highlight{background:linear-gradient(135deg,#00aaff,#0066ff);}
.freeze{background:#ff4c4c;text-align:center;padding:14px;border-radius:12px;margin-top:20px;font-weight:bold;}
.cards-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:20px;max-width:850px;margin:30px auto;padding:0 20px;}
.card{background:linear-gradient(135deg,#1a2b8f,#243bba);padding:28px;border-radius:18px;text-align:center;text-decoration:none;color:#fff;font-weight:600;cursor:pointer;}
.card.disabled{opacity:.4;pointer-events:none;}
.spinner{border:4px solid rgba(255,255,255,0.3);border-top:4px solid #fff;border-radius:50%;width:25px;height:25px;animation:spin 1s linear infinite;}
@keyframes spin{to{transform:rotate(360deg);}}
</style>
</head>
<body>

<header>
  <h2>Dashboard</h2>
  <button class="logout-btn" id="logoutBtn">Logout</button>
</header>

<div class="user-info" id="userInfo" style="display:none;">
  <h2>User Info</h2>

  <div class="info-grid">
    <div class="info-box"><span>Name</span><strong id="name">-</strong></div>
    <div class="info-box"><span>Email</span><strong id="email">-</strong></div>

    <div class="info-box highlight">
      <span>Total Earnings</span>
      <strong id="earnings">$0.00</strong>
    </div>

    <div class="info-box highlight">
      <span>Total Clicks</span>
      <strong id="totalClicks">0</strong>
    </div>

    <div class="info-box">
      <span>Withdraw</span>
      <strong id="withdraw">$0.00</strong>
    </div>

    <div class="info-box" style="grid-column:span 2">
      <span>Date Joined</span>
      <strong id="joined">-</strong>
    </div>
  </div>

  <div id="freezeBox" class="freeze" style="display:none">
    ‚ö† Account Frozen ‚Äì Multiple Devices Detected
  </div>
</div>

<div id="loading" style="display:flex;justify-content:center;align-items:center;height:60vh;">
  <div class="spinner"></div>
</div>

<div class="cards-row" id="cardsRow" style="display:none;">
  <a href="withdraw.html" class="card">üí∏ Withdraw</a>
  <a href="rewards.html" class="card">üèÜ Rewards</a>
  <a href="tasks.html" class="card">üìÖ Tasks</a>
  <a href="notification.html" class="card">üîî Notifications</a>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js";
import { getFirestore, doc, getDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";

const app = initializeApp({
  apiKey: "AIzaSyC536HkcJeBwXuLWzv-e2xl6au6_KeQp5s",
  authDomain: "rewards-6b903.firebaseapp.com",
  projectId: "rewards-6b903",
});

const auth = getAuth(app);
const db = getFirestore(app);

function getFingerprint(){
  return {
    ua:navigator.userAgent,
    platform:navigator.platform,
    lang:navigator.language,
    screen:screen.width+"x"+screen.height,
    tz:Intl.DateTimeFormat().resolvedOptions().timeZone,
    cpu:navigator.hardwareConcurrency||"na",
    ram:navigator.deviceMemory||"na"
  };
}

function scoreMatch(a,b){
  let s=0;
  if(a.ua===b.ua)s+=25;
  if(a.platform===b.platform)s+=15;
  if(a.screen===b.screen)s+=15;
  if(a.tz===b.tz)s+=15;
  if(a.cpu===b.cpu && a.ram===b.ram)s+=15;
  if(a.lang===b.lang)s+=15;
  return s;
}

window.history.pushState(null,"",location.href);
window.onpopstate=()=>window.history.pushState(null,"",location.href);

onAuthStateChanged(auth,async user=>{
  if(!user) return location.replace("index.html");

  const ref=doc(db,"users",user.uid);
  const snap=await getDoc(ref);
  if(!snap.exists()) return location.replace("index.html");

  const d=snap.data();
  const fp=getFingerprint();

  const up={};
  if(!d.deviceFingerprint) up.deviceFingerprint=fp;
  if(!d.createdAt) up.createdAt=serverTimestamp();
  if(!d.totalClicks) up.totalClicks=0;
  if(Object.keys(up).length) await updateDoc(ref,up);

  let freeze=false;
  if(d.deviceFingerprint){
    if(scoreMatch(d.deviceFingerprint,fp)<80){
      freeze=true;
      await updateDoc(ref,{status:"frozen"});
    }
  }

  document.getElementById("loading").style.display="none";
  document.getElementById("userInfo").style.display="block";
  document.getElementById("cardsRow").style.display="grid";

  name.textContent=d.name||"-";
  email.textContent=d.email||"-";
  earnings.textContent="$"+(d.totalEarnings||0).toFixed(2);
  withdraw.textContent="$"+(d.withdraw||0).toFixed(2);
  totalClicks.textContent=d.totalClicks||0;
  joined.textContent=d.createdAt?.toDate?d.createdAt.toDate().toLocaleString():"-";

  if(freeze || d.status==="frozen"){
    freezeBox.style.display="block";
    document.querySelectorAll(".card").forEach(c=>c.classList.add("disabled"));
  }
});

logoutBtn.onclick=async()=>{
  await signOut(auth);
  location.replace("index.html");
};
</script>
</body>
</html>