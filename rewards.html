<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Achievements</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root{
  --bg-main:#071a3a;
  --bg-card:#0e2a5a;
  --bg-progress:#0a1e3f;
  --accent:#3fa9f5;
  --text-soft:#b9d4ff;
}

*{box-sizing:border-box}

body{
  margin:0;
  font-family:"Segoe UI",Roboto,Arial,sans-serif;
  background:linear-gradient(135deg,#050f24,#0a2c66);
  color:#fff;
}

#spinner{
  position:fixed;
  inset:0;
  background:#050f24;
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:9999;
}

.loader{
  width:48px;
  height:48px;
  border:5px solid #1c3f7a;
  border-top:5px solid #3fa9f5;
  border-radius:50%;
  animation:spin 1s linear infinite;
}

@keyframes spin{100%{transform:rotate(360deg)}}

.container{
  padding:24px;
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(260px,1fr));
  gap:24px;
  max-width:1200px;
  margin:auto;
}

.card{
  position:relative;
  background:linear-gradient(180deg,#0f2f66,#0b2450);
  border-radius:16px;
  padding:18px;
  height:160px;
  display:flex;
  flex-direction:column;
  justify-content:space-between;
  box-shadow:0 12px 30px rgba(0,0,0,.45);
}

.card.unlocked{
  animation:wave 2s infinite;
  box-shadow:0 0 18px rgba(63,169,245,.9);
  cursor:pointer;
}

.card.completed{
  opacity:.6;
  cursor:default;
}

@keyframes wave{
  0%,100%{transform:translateY(0)}
  50%{transform:translateY(-6px)}
}

h3{margin:0;font-size:17px}
.sub{font-size:13px;color:var(--text-soft)}

.progress-box{
  height:10px;
  background:#0a1e3f;
  border-radius:20px;
  overflow:hidden;
  margin:14px 0 10px;
}

.progress-bar{
  height:100%;
  width:0%;
  background:linear-gradient(90deg,#3fa9f5,#00e0ff);
  transition:width .8s ease;
}

.stats{
  font-size:13px;
  display:flex;
  justify-content:space-between;
  color:var(--text-soft);
}

.badge{
  position:absolute;
  top:12px;
  right:12px;
  background:#2ecc71;
  color:#003300;
  padding:4px 10px;
  border-radius:20px;
  font-size:11px;
  font-weight:700;
}

.popup{
  position:fixed;
  top:-100px;
  left:50%;
  transform:translateX(-50%);
  background:linear-gradient(90deg,#3fa9f5,#00e0ff);
  color:#002244;
  padding:14px 22px;
  border-radius:30px;
  font-weight:600;
  transition:.5s;
  z-index:999;
}

.popup.show{top:20px}
</style>
</head>

<body>

<div id="spinner"><div class="loader"></div></div>
<div class="container" id="cards"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import { getFirestore, doc, getDoc, updateDoc, arrayUnion } 
from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBe3E2eSUaDH5rZHguezaHjbxKmRA5QVd4",
  authDomain: "rewards-b8f54.firebaseapp.com",
  projectId: "rewards-b8f54",
  storageBucket: "rewards-b8f54.firebasestorage.app",
  messagingSenderId: "588528777945",
  appId: "1:588528777945:web:6dc9600f1f230e3813dcc8"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth();
const db = getFirestore();

const popup = document.createElement("div");
popup.className = "popup";
popup.innerText = "Please check your redeem page and unlock your voucher";
document.body.appendChild(popup);

const showPopup = () => {
  popup.classList.add("show");
  setTimeout(()=>popup.classList.remove("show"),3000);
};

onAuthStateChanged(auth, async user => {
  if(!user) return;

  const userRef = doc(db,"users",user.uid);
  const userSnap = await getDoc(userRef);
  const userData = userSnap.data();

  document.getElementById("spinner").style.display="none";

  loadCards(userRef,userData);
});

function loadCards(userRef,userData){

fetch("data.json")
.then(res=>res.json())
.then(async data=>{

  const container = document.getElementById("cards");

  for(const item of data){

    let unlocked = false;
    let rewardUnlock = 0;

    const rewardRef = doc(db,"rewards",item.id);
    const rewardSnap = await getDoc(rewardRef);

    if(rewardSnap.exists()){
      const reward = rewardSnap.data();

      if(reward.type === "level"){
        unlocked = userData.currentLevel >= reward.need;
      }

      if(reward.type === "engagement"){
        unlocked = (userData.totalEngagement || 0) >= reward.need;
      }

      rewardUnlock = reward.unlock || 0;
    }

    const completed = userData.redeemedVouchers?.includes(item.id);
    const percent = Math.min((item.achieved/item.required)*100,100).toFixed(0);

    const card = document.createElement("div");
    card.className="card";

    if(unlocked && !completed) card.classList.add("unlocked");
    if(completed) card.classList.add("completed");

    card.innerHTML = `
      ${completed?`<div class="badge">COMPLETED</div>`:""}
      <div>
        <h3>${item.title}</h3>
        <div class="sub">${percent}% completed</div>
      </div>
      <div>
        <div class="progress-box"><div class="progress-bar"></div></div>
        <div class="stats">
          <span>${item.achieved} achieved</span>
          <span>${item.required} required</span>
        </div>
      </div>
    `;

    container.appendChild(card);
    setTimeout(()=>card.querySelector(".progress-bar").style.width=percent+"%",100);

    if(unlocked && !completed){
      card.onclick = async ()=>{
        showPopup();
        await updateDoc(userRef,{
          redeemedVouchers: arrayUnion(item.id),
          totalEngagement: (userData.totalEngagement || 0) + rewardUnlock
        });
        card.classList.remove("unlocked");
        card.classList.add("completed");
        card.insertAdjacentHTML("afterbegin",`<div class="badge">COMPLETED</div>`);
      };
    }
  }
});
}
</script>

</body>
</html>