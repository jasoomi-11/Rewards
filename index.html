<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Login</title>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.1/firebase-app.js";
import { getAuth, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.6.1/firebase-auth.js";
import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.6.1/firebase-firestore.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyC536HkcJeBwXuLWzv-e2xl6au6_KeQp5s",
  authDomain: "rewards-6b903.firebaseapp.com",
  projectId: "rewards-6b903"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// Login function
window.login = async (e) => {
  e.preventDefault();

  const email = document.getElementById("email").value.trim();
  const password = document.getElementById("password").value;
  const message = document.getElementById("message");
  message.textContent = "";
  message.style.color = "#333";

  try {
    // Sign in with Firebase Auth
    const cred = await signInWithEmailAndPassword(auth, email, password);
    const user = cred.user;

    // Fetch Firestore user record
    const userRef = doc(db, "users", user.uid);
    const userSnap = await getDoc(userRef);

    if (!userSnap.exists()) {
      message.textContent = "No user record found! Please contact support.";
      message.style.color = "red";
      return;
    }

    // User exists, show message and redirect
    const data = userSnap.data();
    message.textContent = `Welcome ${data.username}! Redirecting...`;
    message.style.color = "green";

    setTimeout(() => window.location.href = "home.html", 1000);

  } catch (err) {
    if (err.code === "auth/user-not-found") {
      message.textContent = "Email not registered. Please sign up first!";
    } else if (err.code === "auth/wrong-password") {
      message.textContent = "Incorrect password!";
    } else {
      message.textContent = err.message;
    }
    message.style.color = "red";
  }
};
</script>

<style>
body {
  margin:0; height:100vh; display:flex; justify-content:center; align-items:center;
  background:#fff; font-family:Arial, sans-serif;
}
.card {
  width:320px; padding:30px; background:#f0f0f0; border-radius:18px; text-align:center;
  box-shadow:0 15px 25px rgba(0,0,0,.3); transition:.3s;
}
.card:hover { transform:perspective(1000px) rotateY(10deg); }
input, button {
  width:100%; padding:10px; margin:8px 0; border-radius:8px; border:1px solid #ccc; outline:none;
}
button {
  background:#007bff; color:#fff; border:none; cursor:pointer;
}
button:hover { background:#0056b3; }
#message { min-height:18px; font-size:14px; margin-top:8px; }
a {color:#007bff;text-decoration:none;font-size:14px}
</style>

</head>
<body>
<div class="card">
  <h2>Login</h2>
  <form onsubmit="login(event)">
    <input id="email" type="email" placeholder="Email" required>
    <input id="password" type="password" placeholder="Password" required>
    <button type="submit">Login</button>
  </form>
  <div id="message"></div>
  <p>Don't have an account? <a href="signup.html">Sign Up</a></p>
</div>
</body>
</html>