<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Waiting for Approval</title>
<style>
* { margin:0; padding:0; box-sizing:border-box; font-family:'Segoe UI',sans-serif; }
body{background:linear-gradient(135deg,#0b1d61,#08123a);color:#fff;display:flex;justify-content:center;align-items:center;height:100vh;flex-direction:column;}
header{width:100%;display:flex;justify-content:flex-end;padding:15px 25px;}
.logout-btn{background:#ff4c4c;border:none;padding:10px 18px;border-radius:8px;color:#fff;cursor:pointer;transition:.3s;}
.logout-btn:hover{opacity:.9;}
.card-container{background:#101e5a;padding:30px;border-radius:20px;box-shadow:0 15px 40px rgba(0,0,0,.5);text-align:center;max-width:400px;width:90%;}
.spinner{border:5px solid rgba(255,255,255,0.2);border-top:5px solid #00aaff;border-radius:50%;width:60px;height:60px;margin:20px auto;animation:spin 1s linear infinite;}
@keyframes spin{0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}
h2{color:#00aaff;margin-bottom:15px;font-size:24px;}
p{opacity:.8;margin-bottom:20px;font-size:16px;}
.notice{background:#1a2b8f;padding:12px 15px;border-radius:12px;box-shadow:0 8px 20px rgba(0,0,0,.3);margin-top:15px;font-size:14px;}
</style>
</head>
<body>

<header>
  <button class="logout-btn" id="logoutBtn">Logout</button>
</header>

<div class="card-container">
  <h2>⏳ Waiting for Approval</h2>
  <div class="spinner"></div>
  <p>Your account is currently pending admin approval.</p>
  <div class="notice">✅ Usually approved within 1 hour.</div>
  <div id="freezeBox" class="notice" style="display:none;background:#ff4c4c;">⚠ Multiple accounts detected on this device – Account Frozen</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js";
import { getFirestore, doc, getDoc, updateDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";

// ✅ Updated Firebase config
const app = initializeApp({
  apiKey: "AIzaSyBe3E2eSUaDH5rZHguezaHjbxKmRA5QVd4",
  authDomain: "rewards-b8f54.firebaseapp.com",
  projectId: "rewards-b8f54",
  storageBucket: "rewards-b8f54.appspot.com",
  messagingSenderId: "588528777945",
  appId: "1:588528777945:web:6dc9600f1f230e3813dcc8"
});

const auth = getAuth(app);
const db = getFirestore(app);

// ===== Device fingerprint
function getFingerprint() {
  return {
    ua: navigator.userAgent,
    platform: navigator.platform,
    lang: navigator.language,
    screen: screen.width + "x" + screen.height,
    tz: Intl.DateTimeFormat().resolvedOptions().timeZone,
    cpu: navigator.hardwareConcurrency || "na",
    ram: navigator.deviceMemory || "na"
  };
}

// ===== Match score
function scoreMatch(a, b) {
  let s = 0;
  if(a.ua === b.ua) s += 25;
  if(a.platform === b.platform) s += 15;
  if(a.screen === b.screen) s += 15;
  if(a.tz === b.tz) s += 15;
  if(a.cpu === b.cpu && a.ram === b.ram) s += 15;
  if(a.lang === b.lang) s += 15;
  return s;
}

// ===== Auth check
onAuthStateChanged(auth, async user => {
  if(!user) return location.replace("index.html");

  const ref = doc(db,"users",user.uid);
  const snap = await getDoc(ref);
  if(!snap.exists()) return location.replace("index.html");

  const data = snap.data();
  const fp = getFingerprint();
  const updates = {};
  if(!data.deviceFingerprint) updates.deviceFingerprint = fp;
  if(!data.totalClicks) updates.totalClicks = 0;
  if(Object.keys(updates).length) await updateDoc(ref, updates);

  // ===== Freeze check for multiple accounts on same device
  let freeze = false;
  const usersSnap = await getDocs(collection(db,"users"));
  for(const docSnap of usersSnap.docs){
    if(docSnap.id === user.uid) continue;
    const u = docSnap.data();
    if(u.deviceFingerprint){
      const score = scoreMatch(u.deviceFingerprint, fp);
      if(score >= 80){
        freeze = true;
        break;
      }
    }
  }
  if(freeze){
    await updateDoc(ref, {status:"frozen"});
    document.getElementById("freezeBox").style.display = "block";
  }

  // ===== If account approved, redirect to dashboard
  if(data.account === "approved" && !freeze){
    location.replace("dashboard.html");
  }
});

// ===== Logout
document.getElementById("logoutBtn").onclick = async () => {
  await signOut(auth);
  location.replace("index.html");
};
</script>

</body>
</html>