<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Profile</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
body { margin:0; padding:0; font-family:'Segoe UI',sans-serif; background:#0b1d61; color:#fff; }
header { display:flex; justify-content:space-between; align-items:center; padding:20px 30px; background:#0a184f; border-bottom:2px solid #00aaff; }
header h1 { font-size:28px; }
.logout-btn { background:#1a2b8f; border:none; padding:10px 18px; border-radius:8px; cursor:pointer; color:#fff; font-weight:500; transition:0.3s; }
.logout-btn:hover { background:#2a3bb5; }

/* Profile container */
.profile-container { max-width:600px; margin:30px auto; background:#1a2b8f; border-radius:12px; padding:25px; box-shadow:0 8px 25px rgba(0,0,0,0.5); position:relative; }
.profile-header { display:flex; align-items:center; margin-bottom:25px; }
.profile-logo { width:70px; height:70px; border-radius:50%; background:#2a3bb5; display:flex; justify-content:center; align-items:center; font-size:32px; font-weight:bold; margin-right:20px; text-transform:uppercase; }
.profile-title { font-size:24px; font-weight:600; }

/* User Info rows */
.info-row { display:flex; justify-content:space-between; padding:10px 0; border-bottom:1px solid rgba(255,255,255,0.2); font-size:16px; }
.info-row:last-child { border-bottom:none; }
.label { font-weight:600; color:#ccc; }
.value { font-weight:500; }

/* Spinner */
.spinner { border:4px solid rgba(255,255,255,0.3); border-top:4px solid #fff; border-radius:50%; width:18px; height:18px; animation:spin 1s linear infinite; display:none; position:absolute; top:25px; right:25px; }
@keyframes spin{0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}

/* Overlay for login prompt */
#loginOverlay { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); display:flex; flex-direction:column; justify-content:center; align-items:center; z-index:9999; color:#fff; text-align:center; padding:20px; display:none; }
#loginOverlay h1 { font-size:32px; margin-bottom:20px; color:#00aaff; }
#loginOverlay p { font-size:20px; margin-bottom:25px; }
#loginOverlay a { background:#1a2b8f; color:#fff; padding:12px 25px; border-radius:8px; text-decoration:none; font-size:18px; transition:0.3s; }
#loginOverlay a:hover { background:#2a3bb5; }

/* Disable pointer events when overlay active */
.overlay-active *:not(#loginOverlay) { pointer-events:none; opacity:0.3; }
</style>
</head>
<body id="body">

<header>
  <h1>Profile</h1>
  <button class="logout-btn" id="logoutBtn">Logout</button>
</header>

<!-- Profile Container -->
<div class="profile-container">
  <div class="spinner" id="loadingSpinner"></div>
  <div class="profile-header">
    <div class="profile-logo" id="profileLogo">S</div>
    <div class="profile-title" id="profileName">Loading...</div>
  </div>
  <div class="info-row"><span class="label">Email:</span> <span class="value" id="email">Loading...</span></div>
  <div class="info-row"><span class="label">Total Earnings:</span> <span class="value" id="totalEarnings">$0.00</span></div>
  <div class="info-row"><span class="label">Today Earnings:</span> <span class="value" id="todayEarnings">$0.00</span></div>
  <div class="info-row"><span class="label">Joined Date:</span> <span class="value" id="joinedDate">-</span></div>
  <div class="info-row"><span class="label">Total Withdraw:</span> <span class="value" id="withdraw">$0.00</span></div>
</div>

<!-- Login Overlay -->
<div id="loginOverlay">
  <h1>Please Log In</h1>
  <p>You must be logged in to access your profile.</p>
  <a href="index.html">Go to Login</a>
</div>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyC536HkcJeBwXuLWzv-e2xl6au6_KeQp5s",
  authDomain: "rewards-6b903.firebaseapp.com",
  projectId: "rewards-6b903",
  storageBucket: "rewards-6b903.firebasestorage.app",
  messagingSenderId: "970714488307",
  appId: "1:970714488307:web:c464136ef40d65607e8686"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

const body = document.getElementById('body');
const overlay = document.getElementById('loginOverlay');
const profileLogo = document.getElementById('profileLogo');
const profileName = document.getElementById('profileName');
const emailEl = document.getElementById('email');
const totalEarningsEl = document.getElementById('totalEarnings');
const todayEarningsEl = document.getElementById('todayEarnings');
const withdrawEl = document.getElementById('withdraw');
const joinedDateEl = document.getElementById('joinedDate');
const logoutBtn = document.getElementById('logoutBtn');
const spinner = document.getElementById('loadingSpinner');

function showSpinner(show){
  spinner.style.display = show ? 'block' : 'none';
}

function formatCurrency(value){
  return `$${parseFloat(value).toFixed(2)}`;
}

function formatDate(timestamp){
  if(!timestamp) return '-';
  const d = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
  return d.toLocaleDateString('en-US', {year:'numeric', month:'long', day:'numeric'});
}

async function loadUser(){
  const user = auth.currentUser;

  if(!user){
    showLoginOverlay();
    return;
  }

  try{
    showSpinner(true);
    const userDoc = await db.collection('users').doc(user.uid).get();
    showSpinner(false);

    if(!userDoc.exists){
      showLoginOverlay();
      return;
    }

    const data = userDoc.data();
    profileName.textContent = data.name;
    profileLogo.textContent = data.name ? data.name.charAt(0).toUpperCase() : 'U';
    emailEl.textContent = data.email;
    totalEarningsEl.textContent = formatCurrency(data.totalEarnings ?? 0);
    todayEarningsEl.textContent = formatCurrency(data.todayEarnings ?? 0);
    withdrawEl.textContent = formatCurrency(data.withdraw ?? 0);
    joinedDateEl.textContent = formatDate(data.createdAt);

  } catch(err){
    showSpinner(false);
    showLoginOverlay();
    console.error('Error loading user data:', err);
  }
}

function showLoginOverlay(){
  overlay.style.display = 'flex';
  body.classList.add('overlay-active');
}

// Logout
logoutBtn.addEventListener('click', async ()=>{
  await auth.signOut();
  window.location.href = 'index.html';
});

// Check auth state
auth.onAuthStateChanged((user)=>{
  if(!user){
    showLoginOverlay();
  } else {
    loadUser();
  }
});
</script>

</body>
</html>