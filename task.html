<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Daily Tasks</title>
<style>
body{margin:0;padding:0;font-family:'Segoe UI',sans-serif;background:#0b1d61;color:#fff;}
header{display:flex;justify-content:space-between;align-items:center;padding:20px 30px;background:#0a184f;border-bottom:2px solid #00aaff;}
header h1{font-size:28px;}
.header-buttons{display:flex;gap:10px;}
.logout-btn, .back-btn{background:#1a2b8f;border:none;padding:10px 18px;border-radius:8px;color:#fff;cursor:pointer;transition:.3s;}
.logout-btn:hover, .back-btn:hover{background:#2a3bb5;}
.tasks-container{display:flex;flex-wrap:wrap;gap:20px;margin:20px auto;max-width:900px;justify-content:center;}
.task-card{flex:1 1 calc(50% - 20px);background:#1a2b8f;padding:15px;border-radius:12px;text-align:center;box-shadow:0 8px 20px rgba(0,0,0,.5);cursor:pointer;position:relative;transition:.3s;}
.task-card:hover{transform:translateY(-5px);box-shadow:0 12px 25px rgba(0,0,0,.6);}
.task-card h3{margin-bottom:10px;}
.task-card button{padding:8px 12px;border:none;border-radius:6px;background:#00aaff;color:#fff;cursor:pointer;transition:.3s;}
.task-card button:disabled{background:#555;cursor:not-allowed;}
#notice{text-align:center;color:#ffcc00;font-weight:bold;margin-top:20px;font-size:18px;}
#spinner{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);border:6px solid rgba(255,255,255,0.3);border-top:6px solid #fff;border-radius:50%;width:50px;height:50px;animation:spin 1s linear infinite;display:none;}
@keyframes spin{0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}
</style>
</head>
<body>

<header>
  <h1>Daily Tasks</h1>
  <div class="header-buttons">
    <button class="back-btn" onclick="location.href='dashboard.html'">Back to Dashboard</button>
    <button class="logout-btn" onclick="logout()">Logout</button>
  </div>
</header>

<div id="spinner"></div>
<div class="tasks-container" id="tasksContainer"></div>
<div id="notice"></div>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey:"AIzaSyC536HkcJeBwXuLWzv-e2xl6au6_KeQp5s",
  authDomain:"rewards-6b903.firebaseapp.com",
  projectId:"rewards-6b903",
  storageBucket:"rewards-6b903.firebasestorage.app",
  messagingSenderId:"970714488307",
  appId:"1:970714488307:web:c464136ef40d65607e8686"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

const spinner = document.getElementById('spinner');
const container = document.getElementById('tasksContainer');
const notice = document.getElementById('notice');

let tasks = [];
let lastClickTime = 0;

function showSpinner(show){spinner.style.display = show ? 'block':'none';}

async function fetchTasksJSON(){
  const res = await fetch('tasks.json');
  return await res.json();
}

function shouldReset(lastDate){
  if(!lastDate) return true;
  const now = new Date();
  const d = lastDate.toDate();
  return d.getDate()!==now.getDate() || d.getMonth()!==now.getMonth() || d.getFullYear()!==now.getFullYear();
}

async function initUserTasks(user){
  showSpinner(true);
  const userRef = db.collection('users').doc(user.uid);
  const userDoc = await userRef.get();
  let reset = true;
  if(userDoc.exists && userDoc.data().tasksDate){
    reset = shouldReset(userDoc.data().tasksDate);
  }

  if(reset){
    const tasksJSON = await fetchTasksJSON();
    const batch = db.batch();
    const tasksRef = userRef.collection('tasks');
    tasksJSON.forEach((task,i)=>{
      const docRef = tasksRef.doc(task.id);
      const unlockTime = (i<7) ? new Date() : new Date(Date.now()+5*60*60*1000);
      batch.set(docRef,{
        title: task.title,
        link: task.link,
        clicksToday:0,
        lastClick:null,
        unlockedAt: unlockTime
      });
    });
    await batch.commit();
    await userRef.update({
      tasksToday:0,
      tasksDate: firebase.firestore.Timestamp.fromDate(new Date())
    });
  }
  showSpinner(false);
}

async function displayTasks(user){
  showSpinner(true);
  const tasksRef = db.collection('users').doc(user.uid).collection('tasks').orderBy('unlockedAt');
  const snapshot = await tasksRef.get();
  container.innerHTML = '';
  let totalClicks = 0;
  snapshot.forEach(doc=> totalClicks += doc.data().clicksToday || 0);

  if(totalClicks>=14){
    notice.textContent = "You already completed all tasks today.";
    showSpinner(false);
    return;
  }

  snapshot.forEach((doc,index)=>{
    const data = doc.data();
    const card = document.createElement('div');
    card.className = 'task-card';

    const now = new Date();
    let isLocked = false;
    if(index<7 && totalClicks>=7) isLocked=true;
    if(index>=7 && now<data.unlockedAt.toDate()) isLocked=true;

    card.innerHTML=`<h3>${data.title}</h3>
      <button ${isLocked?'disabled':''} data-id="${doc.id}">${isLocked?'Locked':'Open Link'}</button>`;
    container.appendChild(card);
  });

  if(totalClicks>=7 && totalClicks<14){
    notice.textContent="You completed first 7 tasks. Come back after 5 hours for remaining!";
  } else {
    notice.textContent='';
  }
  showSpinner(false);
}

container.addEventListener('click', async e=>{
  if(e.target.tagName==='BUTTON' && !e.target.disabled){
    const btn = e.target;
    const taskId = btn.dataset.id;
    const user = auth.currentUser;
    const taskRef = db.collection('users').doc(user.uid).collection('tasks').doc(taskId);
    const taskSnap = await taskRef.get();
    const task = taskSnap.data();
    const now = new Date();

    if(task.lastClick && (now-task.lastClick.toDate())/1000<30){
      alert('Wait 30 seconds before next click!');
      return;
    }

    const tasksSnapshot = await db.collection('users').doc(user.uid).collection('tasks').get();
    let totalClicks=0;
    tasksSnapshot.forEach(doc=> totalClicks+=doc.data().clicksToday||0);
    if(totalClicks>=14){
      alert('Daily click limit reached.');
      displayTasks(user);
      return;
    }

    await taskRef.update({
      clicksToday: (task.clicksToday||0)+1,
      lastClick: firebase.firestore.Timestamp.fromDate(now)
    });

    window.open(task.link,'_blank');
    displayTasks(user);
  }
});

function logout(){
  auth.signOut();
  location.href='index.html';
}

auth.onAuthStateChanged(async user=>{
  if(!user){
    alert('Please login first');
    location.href='index.html';
  } else {
    await initUserTasks(user);
    displayTasks(user);
  }
});
</script>
</body>
</html>