<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Withdraw</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI',sans-serif;}
body{background:linear-gradient(135deg,#0b1d61,#08123a);color:#fff;min-height:100vh;}
header{display:flex;justify-content:space-between;align-items:center;padding:16px 20px;background:#0a184f;}
header h2{color:#00aaff;}
header button{border:none;padding:8px 16px;border-radius:8px;background:#2563eb;color:#fff;cursor:pointer;}
.user-info{max-width:600px;margin:20px auto;background:#101e5a;padding:20px;border-radius:18px;box-shadow:0 20px 40px rgba(0,0,0,.4);}
.user-info h3{margin-bottom:15px;color:#00aaff;text-align:center;}
.info-box{background:#1a2b8f;padding:12px;margin:10px 0;border-radius:12px;}
.info-box strong{display:block;margin-top:5px;}
.withdraw-form{max-width:600px;margin:20px auto;background:#1a2b8f;padding:20px;border-radius:18px;box-shadow:0 20px 40px rgba(0,0,0,.4);}
.withdraw-form h3{color:#00aaff;text-align:center;margin-bottom:15px;}
.withdraw-form label{display:block;margin:10px 0 5px;}
.withdraw-form input, .withdraw-form select{width:100%;padding:10px;border-radius:8px;border:none;margin-bottom:10px;}
.withdraw-form button{width:100%;padding:12px;background:#22c55e;color:#000;font-weight:bold;border:none;border-radius:8px;cursor:pointer;}
.freeze, .warning{background:#ff4c4c;text-align:center;padding:14px;border-radius:12px;margin:20px auto;font-weight:bold;display:none;}
.warning{background:#ffbf00;}
.spinner-overlay {position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:1000;display:none;}
.spinner {border:6px solid rgba(255,255,255,0.3);border-top:6px solid #fff;border-radius:50%;width:50px;height:50px;animation:spin 1s linear infinite;}
@keyframes spin{0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}
</style>
</head>
<body>

<header>
  <h2>Withdraw</h2>
  <div>
    <button onclick="location.href='dashboard.html'">Home</button>
    <button id="logoutBtn">Logout</button>
  </div>
</header>

<div class="user-info" id="userInfo" style="display:none;">
  <h3>User Info</h3>
  <div class="info-box"><span>Total Clicks</span><strong id="totalClicks">0</strong></div>
  <div class="info-box"><span>Total Earnings</span><strong id="totalEarnings">$0.00</strong></div>
</div>

<div class="freeze" id="freezeBox">⚠ Account Frozen – Multiple Devices Detected</div>
<div class="warning" id="warnBox">⚠ Warning: Account used from an unusual device!</div>

<div class="withdraw-form" id="withdrawForm" style="display:none;">
  <h3>Withdraw Request</h3>
  <label for="method">Select Method</label>
  <select id="method">
    <option value="Jazzcash">Jazzcash</option>
    <option value="Easypaisa">Easypaisa</option>
    <option value="Sadapay">Sadapay</option>
  </select>

  <label for="username">Your Name</label>
  <input type="text" id="username" placeholder="Enter your name">

  <label for="phone">Phone Number</label>
  <input type="text" id="phone" placeholder="Enter phone number">

  <label for="amount">Amount (USD)</label>
  <input type="number" id="amount" placeholder="Enter amount" step="0.01" min="1.8">

  <button id="submitBtn">Submit Withdraw Request</button>
</div>

<div class="spinner-overlay" id="spinnerOverlay"><div class="spinner"></div></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js";
import { getFirestore, doc, getDoc, updateDoc, addDoc, collection, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";

const app = initializeApp({
  apiKey: "AIzaSyC536HkcJeBwXuLWzv-e2xl6au6_KeQp5s",
  authDomain: "rewards-6b903.firebaseapp.com",
  projectId: "rewards-6b903"
});

const auth = getAuth(app);
const db = getFirestore(app);

const spinner = document.getElementById("spinnerOverlay");
const userInfoDiv = document.getElementById("userInfo");
const withdrawFormDiv = document.getElementById("withdrawForm");
const freezeBox = document.getElementById("freezeBox");
const warnBox = document.getElementById("warnBox");

function showSpinner(v){ spinner.style.display = v ? "flex" : "none"; }

function getFingerprint(){
  return {
    ua: navigator.userAgent,
    platform: navigator.platform,
    lang: navigator.language,
    screen: screen.width+"x"+screen.height,
    tz: Intl.DateTimeFormat().resolvedOptions().timeZone,
    cpu: navigator.hardwareConcurrency||"na",
    ram: navigator.deviceMemory||"na"
  };
}

function calculateScore(a,b){
  let score=0;
  if(a.ua===b.ua)score+=25;
  if(a.platform===b.platform)score+=15;
  if(a.screen===b.screen)score+=15;
  if(a.tz===b.tz)score+=15;
  if(a.cpu===b.cpu && a.ram===b.ram)score+=15;
  if(a.lang===b.lang)score+=15;
  return score;
}

onAuthStateChanged(auth, async user => {
  if(!user) return location.href="index.html";
  showSpinner(true);

  const userRef = doc(db,"users",user.uid);
  const snap = await getDoc(userRef);
  if(!snap.exists()) return location.href="index.html";

  const data = snap.data();
  const fp = getFingerprint();

  // First time init
  const updates = {};
  if(!data.deviceFingerprint) updates.deviceFingerprint = fp;
  if(!data.totalClicks) updates.totalClicks = 0;
  if(!data.totalEarnings) updates.totalEarnings = 0;
  if(Object.keys(updates).length) await updateDoc(userRef, updates);

  // Device score check
  let score = 0;
  let freeze = false;
  let flag = false;
  if(data.deviceFingerprint){
    score = calculateScore(data.deviceFingerprint, fp);
    if(score >= 80){
      freeze = true;
      await updateDoc(userRef,{status:"frozen", lastDeviceScore:score});
    } else if(score >= 60 && score < 80){
      flag = true;
      await updateDoc(userRef,{lastDeviceScore:score, flagged:true});
    }
  }

  // Show UI based on score
  showSpinner(false);
  if(freeze || data.status==="frozen"){
    freezeBox.style.display="block";
    withdrawFormDiv.style.display="none";
  } else {
    userInfoDiv.style.display="block";
    withdrawFormDiv.style.display="block";
    if(flag) warnBox.style.display="block";

    document.getElementById("totalClicks").textContent = data.totalClicks || 0;
    document.getElementById("totalEarnings").textContent = "$" + (data.totalEarnings || 0).toFixed(2);
  }

  // Withdraw submit
  document.getElementById("submitBtn").onclick = async () => {
    const method = document.getElementById("method").value;
    const username = document.getElementById("username").value.trim();
    const phone = document.getElementById("phone").value.trim();
    const amount = parseFloat(document.getElementById("amount").value);

    if(!username || !phone || !amount){
      alert("⚠ Fill all fields correctly");
      return;
    }
    if(amount < 1.8){
      alert("⚠ Minimum withdraw amount is $1.8");
      return;
    }
    if(data.totalClicks < 140){
      alert("⚠ Need at least 140 clicks to withdraw");
      return;
    }

    showSpinner(true);
    try{
      await addDoc(collection(db,"withdrawals"),{
        uid: user.uid,
        method,
        name: username,
        phone,
        amount,
        status: "pending",
        createdAt: serverTimestamp()
      });
      alert("✅ Withdraw request submitted!");
      document.getElementById("username").value="";
      document.getElementById("phone").value="";
      document.getElementById("amount").value="";
    } catch(e){
      console.error(e);
      alert("⚠ Error submitting withdraw request");
    }
    showSpinner(false);
  };
});

// Logout
document.getElementById("logoutBtn").onclick = async ()=>{
  await signOut(auth);
  location.href="index.html";
};
</script>
</body>
</html>