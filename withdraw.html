<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Withdraw</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI',sans-serif;}
body{background:linear-gradient(135deg,#0b1d61,#08123a);color:#fff;min-height:100vh;}
header{display:flex;justify-content:space-between;align-items:center;padding:16px 20px;background:#0a184f;}
header h2{color:#00aaff;}
header button{border:none;padding:8px 16px;border-radius:8px;background:#2563eb;color:#fff;cursor:pointer;margin-left:10px;}
.user-info{max-width:600px;margin:20px auto;background:#101e5a;padding:20px;border-radius:18px;box-shadow:0 20px 40px rgba(0,0,0,.4);}
.user-info h3{margin-bottom:10px;color:#00aaff;text-align:center;}
.info-box{background:#1a2b8f;padding:12px;margin:10px 0;border-radius:12px;}
.info-box strong{display:block;margin-top:5px;}
.withdraw-form{max-width:600px;margin:20px auto;background:#1a2b8f;padding:20px;border-radius:18px;box-shadow:0 20px 40px rgba(0,0,0,.4);}
.withdraw-form h3{color:#00aaff;text-align:center;margin-bottom:10px;}
.withdraw-form p{color:#fff;font-size:14px;margin-bottom:15px;}
.withdraw-form label{display:block;margin:10px 0 5px;}
.withdraw-form input, .withdraw-form select{width:100%;padding:10px;border-radius:8px;border:none;margin-bottom:10px;}
.withdraw-form button{width:100%;padding:12px;background:#22c55e;color:#000;font-weight:bold;border:none;border-radius:8px;cursor:pointer;}
.freeze{background:#ff4c4c;text-align:center;padding:14px;border-radius:12px;margin:20px auto;font-weight:bold;display:none;}
.spinner-overlay {position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:1000;display:none;}
.spinner {border:6px solid rgba(255,255,255,0.3);border-top:6px solid #fff;border-radius:50%;width:50px;height:50px;animation:spin 1s linear infinite;}
@keyframes spin{0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}
.withdraw-history{max-width:600px;margin:20px auto;background:#101e5a;padding:20px;border-radius:18px;box-shadow:0 20px 40px rgba(0,0,0,.4);}
.withdraw-history h3{color:#00aaff;text-align:center;margin-bottom:15px;}
.withdraw-item{background:#1a2b8f;padding:12px;margin:10px 0;border-radius:12px;}
.withdraw-item span{display:block;font-size:14px;margin-top:3px;}
</style>
</head>
<body>

<header>
  <h2>Withdraw</h2>
  <div>
    <button onclick="location.href='dashboard.html'">Home</button>
    <button id="logoutBtn">Logout</button>
  </div>
</header>

<div id="spinnerOverlay" class="spinner-overlay"><div class="spinner"></div></div>

<div class="user-info" id="userInfo" style="display:none;">
  <h3>User Info</h3>
  <div class="info-box"><span>Total Clicks</span><strong id="totalClicks">0</strong></div>
  <div class="info-box"><span>Total Earnings</span><strong id="totalEarnings">$0.00</strong></div>
</div>

<div class="freeze" id="freezeBox">⚠ Account Frozen – Multiple Accounts Detected or Your Account is Frozen</div>

<div class="withdraw-form" id="withdrawForm" style="display:none;">
  <h3>Withdraw Request</h3>
  <p>Minimum $1 & at least 140 clicks required.</p>
  <label for="method">Select Method</label>
  <select id="method">
    <option value="Jazzcash">Jazzcash</option>
    <option value="Easypaisa">Easypaisa</option>
    <option value="Sadapay">Sadapay</option>
  </select>

  <label for="username">Your Name</label>
  <input type="text" id="username" placeholder="Enter your name">

  <label for="phone">Phone Number</label>
  <input type="text" id="phone" placeholder="Enter phone number">

  <label for="amount">Amount (USD)</label>
  <input type="number" id="amount" placeholder="Enter amount" step="0.01" min="1">

  <button id="submitBtn">Submit Withdraw Request</button>
</div>

<div class="withdraw-history" id="withdrawHistory" style="display:none;">
  <h3>Your Withdrawal History</h3>
  <div id="historyList"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js";
import { getFirestore, doc, getDoc, addDoc, collection, serverTimestamp, query, where, orderBy, getDocs } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";

// ✅ Updated Firebase config
const app = initializeApp({
  apiKey: "AIzaSyBe3E2eSUaDH5rZHguezaHjbxKmRA5QVd4",
  authDomain: "rewards-b8f54.firebaseapp.com",
  projectId: "rewards-b8f54",
  storageBucket: "rewards-b8f54.appspot.com",
  messagingSenderId: "588528777945",
  appId: "1:588528777945:web:6dc9600f1f230e3813dcc8"
});

const auth = getAuth(app);
const db = getFirestore(app);

const spinner = document.getElementById("spinnerOverlay");
const userInfoDiv = document.getElementById("userInfo");
const withdrawFormDiv = document.getElementById("withdrawForm");
const freezeBox = document.getElementById("freezeBox");
const historyDiv = document.getElementById("withdrawHistory");
const historyList = document.getElementById("historyList");

function showSpinner(v){ spinner.style.display = v ? "flex" : "none"; }

// Prevent back button after logout
window.history.pushState(null, "", location.href);
window.onpopstate = () => { window.history.pushState(null, "", location.href); location.replace("index.html"); };

onAuthStateChanged(auth, async user => {
  if(!user) return location.href="index.html";
  showSpinner(true);

  const userRef = doc(db,"users",user.uid);
  const snap = await getDoc(userRef);
  if(!snap.exists()) return location.href="index.html";
  const data = snap.data();

  // Check account status
  if(data.status === "frozen"){
    freezeBox.style.display="block";
    withdrawFormDiv.style.display="none";
    showSpinner(false);
    return;
  }

  userInfoDiv.style.display="block";
  withdrawFormDiv.style.display="block";
  document.getElementById("totalClicks").textContent = data.totalClicks || 0;
  document.getElementById("totalEarnings").textContent = "$" + (data.totalEarnings || 0).toFixed(2);

  showSpinner(false);

  // Load withdrawal history
  async function loadHistory(){
    historyList.innerHTML="";
    const q = query(collection(db,"withdrawals"), where("uid","==",user.uid), orderBy("createdAt","desc"));
    const querySnap = await getDocs(q);
    if(querySnap.empty){
      historyList.innerHTML="<p>No withdrawal requests yet.</p>";
    }
    querySnap.forEach(docSnap=>{
      const w = docSnap.data();
      const status = w.status || "pending";
      const div = document.createElement("div");
      div.classList.add("withdraw-item");
      div.innerHTML = `
        <strong>Status: ${status.toUpperCase()}</strong>
        <span>Name: ${w.name}</span>
        <span>Method: ${w.method}</span>
        <span>Amount: $${w.amount}</span>
        <span>Email: ${w.email || user.email}</span>
      `;
      historyList.appendChild(div);
    });
    historyDiv.style.display = "block";
  }
  loadHistory();

  // Submit withdraw
  document.getElementById("submitBtn").onclick = async ()=>{
    const method = document.getElementById("method").value;
    const username = document.getElementById("username").value.trim();
    const phone = document.getElementById("phone").value.trim();
    const amount = parseFloat(document.getElementById("amount").value);

    if(!username || !phone || !amount){
      alert("⚠ Fill all fields correctly");
      return;
    }
    if(amount < 1){
      alert("⚠ Minimum withdraw amount is $1");
      return;
    }
    if(data.totalClicks < 140){
      alert("⚠ Need at least 140 clicks to withdraw");
      return;
    }

    showSpinner(true);
    try{
      await addDoc(collection(db,"withdrawals"),{
        uid: user.uid,
        email: user.email,
        name: username,
        phone,
        method,
        amount,
        status: "pending",
        createdAt: serverTimestamp()
      });

      // Redirect to WhatsApp
      const msg = `Hello, I want to withdraw.\nName: ${username}\nMethod: ${method}\nAmount: $${amount}\nUID: ${user.uid}\nEmail: ${user.email}`;
      window.open(`https://wa.me/03350028407?text=${encodeURIComponent(msg)}`,"_blank");

      // Clear form
      document.getElementById("username").value="";
      document.getElementById("phone").value="";
      document.getElementById("amount").value="";

      loadHistory();

    } catch(e){
      console.error(e);
      alert("⚠ Error submitting withdraw request");
    }
    showSpinner(false);
  };
});

// Logout
document.getElementById("logoutBtn").onclick = async ()=>{
  await signOut(auth);
  location.href="index.html";
};
</script>
</body>
</html>