<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Withdraw</title>


<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js";
import { getFirestore, doc, getDoc, updateDoc, addDoc, collection, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyBe3E2eSUaDH5rZHguezaHjbxKmRA5QVd4",
  authDomain: "rewards-b8f54.firebaseapp.com",
  projectId: "rewards-b8f54",
  storageBucket: "rewards-b8f54.appspot.com",
  messagingSenderId: "588528777945",
  appId: "1:588528777945:web:6dc9600f1f230e3813dcc8"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const spinner = document.getElementById("spinnerOverlay");
const userInfoDiv = document.getElementById("userInfo");
const withdrawFormDiv = document.getElementById("withdrawForm");
const freezeBox = document.getElementById("freezeBox");
const popup = document.getElementById("popupMessage");

function showSpinner(show){ spinner.style.display = show ? "flex" : "none"; }
function showPopup(msg, isError=false){
  popup.textContent = msg;
  popup.className = "popup-msg" + (isError?" error":"");
  popup.style.display="block";
  setTimeout(()=>{ popup.style.display="none"; },5000);
}

// Prevent back after logout
window.history.pushState(null, "", location.href);
window.onpopstate = ()=>{ window.history.pushState(null, "", location.href); location.replace("index.html"); };

onAuthStateChanged(auth, async user=>{
  if(!user) return location.href="index.html";

  showSpinner(true);
  try {
    const userRef = doc(db,"users",user.uid);
    const snap = await getDoc(userRef);
    if(!snap.exists()){
      showPopup("âš  User record not found", true);
      showSpinner(false);
      return;
    }
    const data = snap.data();

    if(data.status === "flagged"){
      freezeBox.style.display="block";
      withdrawFormDiv.style.display="none";
      showSpinner(false);
      return;
    }

    userInfoDiv.style.display="block";
    withdrawFormDiv.style.display="block";
    document.getElementById("totalClicks").textContent = data.totalClicks ?? 0;

    const lastWithdraw = data.lastWithdraw?.toDate ? data.lastWithdraw.toDate() : null;
    const now = new Date();

    if(lastWithdraw){
      const diffMs = now - lastWithdraw; // milliseconds
      const diffDays = diffMs / (1000*60*60*24); // convert to days
      if(diffDays < 2){
        showPopup(`âš  You can withdraw only once every 2 days. Next withdraw available in ${(2-diffDays).toFixed(1)} days`, true);
        document.getElementById("submitBtn").disabled = true;
      } else {
        document.getElementById("submitBtn").disabled = false;
      }
    }

    if((data.totalClicks ?? 0) < 1000){
      showPopup("âš  You need at least 1000 clicks to withdraw", true);
    }

  } catch(e){
    console.error(e);
    showPopup("âš  Error loading user data", true);
  }
  showSpinner(false);
});

// Submit withdraw
document.getElementById("submitBtn").onclick=async()=>{
  const method = document.getElementById("method").value;
  const username = document.getElementById("username").value.trim();
  const phone = document.getElementById("phone").value.trim();
  const clicks = parseInt(document.getElementById("clicks").value);

  if(!username || !phone || !clicks || clicks < 1000){
    showPopup("âš  Fill all fields correctly and minimum 1000 clicks", true);
    return;
  }

  showSpinner(true);
  try{
    const user = auth.currentUser;
    const userRef = doc(db,"users",user.uid);
    const snap = await getDoc(userRef);
    const data = snap.data();

    const lastWithdraw = data.lastWithdraw?.toDate ? data.lastWithdraw.toDate() : null;
    const now = new Date();
    if(lastWithdraw){
      const diffMs = now - lastWithdraw;
      const diffDays = diffMs / (1000*60*60*24);
      if(diffDays < 2){
        showPopup("âš  You cannot withdraw yet. Wait for 2 days after last withdrawal.", true);
        showSpinner(false);
        return;
      }
    }

    // Add withdrawal request
    await addDoc(collection(db,"withdrawals"),{
      uid: user.uid,
      email: user.email,
      name: username,
      account: phone,
      method,
      amount: clicks,
      status: "pending",
      createdAt: serverTimestamp()
    });

    // Update lastWithdraw in users
    await updateDoc(userRef,{
      lastWithdraw: serverTimestamp()
    });

    const msg = `Hello, I want to withdraw.\nName: ${username}\nMethod: ${method}\nClicks: ${clicks}\nUID: ${user.uid}\nEmail: ${user.email}\nAccount: ${phone}`;
    window.open(`https://wa.me/033500284007?text=${encodeURIComponent(msg)}`,"_blank");

    document.getElementById("username").value="";
    document.getElementById("phone").value="";
    document.getElementById("clicks").value="";
    showPopup("âœ… Withdraw request submitted successfully!");
    document.getElementById("submitBtn").disabled = true; // disable until 2 days

  } catch(e){
    console.error(e);
    showPopup("âš  Error submitting withdraw request", true);
  }
  showSpinner(false);
};

// Logout
document.getElementById("logoutBtn").onclick=async()=>{
  await signOut(auth);
  location.href="index.html";
};
</script>







<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI',sans-serif;}
body{background:linear-gradient(135deg,#0b1d61,#08123a);color:#fff;min-height:100vh;}


/* Header container */
header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px 25px;
  background: #0a184f;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
  position: sticky;
  top: 0;
  z-index: 100;
}

/* Left - Logo */
.header-left .logo {
  width: 50px;
  height: 50px;
  border-radius: 50%;
  object-fit: cover;
  border: 2px solid #00aaff;
}

/* Right - User profile */
.header-right .user-profile {
  width: 48px;
  height: 48px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  border: 2px solid #00aaff;
  cursor: pointer;
  transition: transform 0.3s, box-shadow 0.3s;
  background: #1a2b8f;
  font-size: 22px;
  text-decoration: none; /* Remove underline for <a> */
  color: inherit;
}
.header-right .user-profile:hover {
  transform: scale(1.1);
  box-shadow: 0 0 15px #00aaff80;
}

/* Profile icon inside */
.profile-icon {
  display: inline-block;
  line-height: 1;
  user-select: none;
}



.user-info, .withdraw-form, .withdraw-history{max-width:600px;margin:20px auto;padding:20px;border-radius:18px;box-shadow:0 20px 40px rgba(0,0,0,.4);}
.user-info{background:#101e5a;}
.withdraw-form{background:#1a2b8f;}
.withdraw-history{background:#101e5a;}
.user-info h3, .withdraw-form h3, .withdraw-history h3{color:#00aaff;text-align:center;margin-bottom:10px;}
.info-box, .withdraw-item{background:#1a2b8f;padding:12px;margin:10px 0;border-radius:12px;}
.info-box strong, .withdraw-item strong{display:block;margin-top:5px;}
.withdraw-form label{display:block;margin:10px 0 5px;}
.withdraw-form input, .withdraw-form select{width:100%;padding:10px;border-radius:8px;border:none;margin-bottom:10px;}
.withdraw-form button{width:100%;padding:12px;background:#22c55e;color:#000;font-weight:bold;border:none;border-radius:8px;cursor:pointer;}
.freeze{background:#ff4c4c;text-align:center;padding:14px;border-radius:12px;margin:20px auto;font-weight:bold;display:none;}
.inline-msg{background:#ff9800;padding:10px;border-radius:8px;margin-bottom:10px;display:none;}
.popup-msg{position:fixed;top:20px;left:50%;transform:translateX(-50%);background:#22c55e;color:#000;padding:12px 20px;border-radius:12px;font-weight:bold;z-index:9999;display:none;}
.popup-msg.error{background:#ff4c4c;color:#fff;}
.spinner-overlay {position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:1000;display:none;}
.spinner {border:6px solid rgba(255,255,255,0.3);border-top:6px solid #fff;border-radius:50%;width:50px;height:50px;animation:spin 1s linear infinite;}
@keyframes spin{0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}
</style>
</head>
<body>

<div id="spinnerOverlay" class="spinner-overlay"><div class="spinner"></div></div>


<header>
  <div class="header-left">
    <img src="logo.png" alt="Logo" class="logo">
  </div>
  <div class="header-right">
    <a href="profile.html" class="user-profile">
      <span class="profile-icon">ğŸ‘¤</span>
    </a>
  </div>
</header>


<br>
<a href="dashboard.html" 
   style="display:inline-block;
          padding:10px 20px;
          background: linear-gradient(135deg,#00aaff,#0056cc);
          color:#fff;
          font-weight:400;
          border-radius:10px;
          text-decoration:none;
          box-shadow:0 6px 5px rgba(0,0,0,0.3);
          transition: all 0.3s;
          font-family:'Segoe UI',sans-serif;">
  â¬… Back
</a>





<div id="popupMessage" class="popup-msg"></div>

<div class="user-info" id="userInfo" style="display:none;">
  <h3>User Info</h3>
  <div class="info-box"><span>Total Clicks</span><strong id="totalClicks">0</strong></div>
</div>

<div class="freeze" id="freezeBox">âš  Account Frozen â€“ Multiple Accounts Detected or Your Account is Frozen</div>

<div class="withdraw-form" id="withdrawForm" style="display:none;">
  <h3>Withdraw Request</h3>
  <p>Minimum 1000 clicks required to withdraw.</p>
  <div class="inline-msg" id="formMessage"></div>

  <label for="method">Select Method</label>
  <select id="method">
    <option value="Jazzcash">Jazzcash</option>
    <option value="Easypaisa">Easypaisa</option>
    <option value="Sadapay">Sadapay</option>
  </select>

  <label for="username">Your Name</label>
  <input type="text" id="username" placeholder="Enter your name">

  <label for="phone">Phone / Account Number</label>
  <input type="text" id="phone" placeholder="Enter phone number / account">

  <label for="clicks">Enter Clicks</label>
  <input type="number" id="clicks" placeholder="Enter clicks" step="1" min="1000">

  <button id="submitBtn">Submit Withdraw Request</button>

  <div style="margin-top:20px;background:#222244;padding:12px;border-radius:12px;">
    <p>Withdrawals are based on your valid clicks. You will receive earnings based on your clicks. <strong>Higher valid clicks = higher earnings!</strong></p>
    <p>ÙˆØ§Ù¾Ø³ÛŒ Ø¢Ù¾ Ú©Û’ Ø¯Ø±Ø³Øª Ú©Ù„Ú©Ø³ Ú©ÛŒ Ø¨Ù†ÛŒØ§Ø¯ Ù¾Ø± ÛÙˆÚ¯ÛŒÛ” Ø¬ØªÙ†Ø§ Ø²ÛŒØ§Ø¯Û Ø¯Ø±Ø³Øª Ú©Ù„Ú©Ø³ØŒ Ø§ØªÙ†Ø§ Ø²ÛŒØ§Ø¯Û Ù¾ÛŒØ³Û Ø¢Ù¾ Ú©Ùˆ Ù…Ù„Û’ Ú¯Ø§Û”</p>
  </div>
</div>

<div class="withdraw-history" id="withdrawHistory" style="display:none;">
  <h3>Your Withdrawal History</h3>
  <div id="historyList"></div>
</div>


</body>
</html>